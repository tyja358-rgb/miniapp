<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>KWT ‚ö° –°–∫–∏–¥–∫–∏ —Ä—è–¥–æ–º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f7ff;
      margin: 0;
      padding: 15px;
    }
    h2 { text-align: center; }
    .card {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    input, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; }
    button { background: #4CAF50; color: #fff; border: none; cursor: pointer; }
    button.secondary { background: #2196F3; }
    button:disabled { background: #999; cursor: not-allowed; }
    img { max-width: 100%; border-radius: 8px; margin-top: 10px; position: relative; }
    .product { border-bottom: 1px solid #eee; padding: 10px 0; position: relative; }
    .category { font-weight: bold; color: #4CAF50; }
    .ad-screen {
      position: fixed;
      inset: 0;
      background: #000;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 999;
    }
    .discount-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #e53935;
      color: #fff;
      font-weight: bold;
      padding: 5px 8px;
      border-radius: 6px;
      font-size: 14px;
    }
    .warning { color: #d9534f; font-weight: bold; margin-top: 5px; }
  </style>
</head>
<body>

<h2>‚ö° –°–∫–∏–¥–∫–∏ —Ä—è–¥–æ–º</h2>

<div class="card">
  <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É</h3>
  <input type="file" id="photo" accept="image/*" capture="environment">
  <img id="preview" style="display:none;">
  <input type="text" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
  <input type="number" id="priceBefore" placeholder="–¶–µ–Ω–∞ –¥–æ">
  <input type="number" id="priceAfter" placeholder="–¶–µ–Ω–∞ –ø–æ—Å–ª–µ">
  <input type="text" id="store" placeholder="–ú–∞–≥–∞–∑–∏–Ω">
  <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞">
  <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
</div>

<div class="card">
  <h3>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–∫–∏–¥–∫–∏</h3>
  <div id="list"></div>
</div>

<div class="ad-screen" id="adScreen">
  <h2>üì¢ –†–µ–∫–ª–∞–º–∞</h2>
  <p>–†–µ–∫–ª–∞–º–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</p>
  <p id="adTimer">5</p>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const photoInput = document.getElementById('photo');
  const preview = document.getElementById('preview');
  const addBtn = document.getElementById('addBtn');
  const list = document.getElementById('list');
  const adScreen = document.getElementById('adScreen');
  const adTimer = document.getElementById('adTimer');

  let photoData = null;
  const products = [];

  photoInput.addEventListener('change', () => {
    const file = photoInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      photoData = e.target.result;
      preview.src = photoData;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  function detectCategory(name) {
    const t = name.toLowerCase();
    if (t.includes('–∞–≤—Ç–æ')) return '–ê–≤—Ç–æ';
    if (t.includes('–µ–¥–∞') || t.includes('–∫–∞—Ñ–µ')) return '–ï–¥–∞';
    if (t.includes('–±–∏–ª–µ—Ç')) return '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è';
    if (t.includes('–æ–¥–µ–∂')) return '–û–¥–µ–∂–¥–∞';
    return '–î—Ä—É–≥–æ–µ';
  }

  function showAd(callback) {
    let time = 5;
    adTimer.innerText = time;
    adScreen.style.display = 'flex';
    const interval = setInterval(() => {
      time--;
      adTimer.innerText = time;
      if (time <= 0) {
        clearInterval(interval);
        adScreen.style.display = 'none';
        callback();
      }
    }, 1000);
  }

  function renderProducts() {
    list.innerHTML = '';
    const now = Date.now();
    products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product';
      const discountPercent = Math.round((1 - p.priceAfter / p.priceBefore) * 100);
      const expired24 = now > p.added + 24*60*60*1000 && now <= p.added + 72*60*60*1000;
      div.innerHTML = `
        <div class="category">${p.category}</div>
        <strong>${p.name}</strong><br>
        ${p.store}, ${p.address}<br>
        <div>–¶–µ–Ω–∞: <s>${p.priceBefore}</s> ‚Üí ${p.priceAfter} (${discountPercent}%)</div>
        <div style="position:relative;">
          <img src="${p.photo}">
          <div class="discount-badge">-${discountPercent}%</div>
        </div>
        ${expired24 ? '<div class="warning">‚ö† –°–∫–∏–¥–∫–∞ –µ—â—ë –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å</div>' : ''}
      `;
      list.prepend(div);
    });
  }

  addBtn.addEventListener('click', () => {
    const name = document.getElementById('productName').value.trim();
    const priceBefore = Number(document.getElementById('priceBefore').value);
    const priceAfter = Number(document.getElementById('priceAfter').value);
    const store = document.getElementById('store').value.trim();
    const address = document.getElementById('address').value.trim();

    if (!photoData || !name || !store || !address || priceBefore <= 0 || priceAfter <= 0 || priceAfter >= priceBefore) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ü–µ–Ω–∞ –ø–æ—Å–ª–µ < —Ü–µ–Ω–∞ –¥–æ');
      return;
    }

    const duplicate = products.find(p => p.name.toLowerCase() === name.toLowerCase() && p.store.toLowerCase() === store.toLowerCase());
    if (duplicate) {
      alert('–¢–∞–∫–æ–π —Ç–æ–≤–∞—Ä —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑–µ!');
      return;
    }

    showAd(() => {
      const category = detectCategory(name);
      products.push({name, store, address, priceBefore, priceAfter, category, photo: photoData, added: Date.now()});
      renderProducts();

      // –æ—á–∏—Å—Ç–∫–∞
      photoInput.value = '';
      preview.style.display = 'none';
      document.getElementById('productName').value = '';
      document.getElementById('priceBefore').value = '';
      document.getElementById('priceAfter').value = '';
      document.getElementById('store').value = '';
      document.getElementById('address').value = '';

      alert('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω. –°–ø–∞—Å–∏–±–æ, –≤–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±–µ—Å—Ü–µ–Ω–Ω–∞.');
    });
  });

  renderProducts();
</script>

</body>
</html>

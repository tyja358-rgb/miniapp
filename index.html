<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniApp - Скидки</title>
<style>
  /* ===== Общий фон ===== */
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #4b0082, #8a2be2);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    color: #fff;
  }

  /* ===== Главные экраны ===== */
  .screen {
    position: absolute;
    width: 100%;
    height: 100%;
    top:0; left:0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: 0.3s;
    opacity: 0;
    pointer-events: none;
  }
  .screen.active {
    opacity: 1;
    pointer-events: all;
  }

  /* ===== Кнопки ===== */
  button {
    background: #222;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 160px;
    height: 160px;
    font-size: 1.2rem;
    margin: 20px;
    cursor: pointer;
    box-shadow: 0 0 20px rgba(255,255,255,0.3);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  button:hover {
    transform: scale(1.1);
    box-shadow: 0 0 40px rgba(255,255,255,0.6);
  }

  /* ===== Шкала энергии ===== */
  .energy-bar-container {
    width: 80%;
    height: 20px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    margin-top: 30px;
    overflow: hidden;
  }
  .energy-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #ffea00, #ffd700);
    border-radius: 10px;
    transition: width 0.3s;
  }
  .energy-text {
    margin-top: 5px;
    font-weight: bold;
  }

  /* ===== Экран добавления ===== */
  .add-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 80%;
    max-width: 400px;
  }
  input, select {
    padding: 10px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
  }
  #photo-preview {
    max-width: 100%;
    display: none;
    border-radius: 8px;
  }

  .back-btn {
    margin-top: 20px;
    background: #444;
    border-radius: 8px;
    width: 100px;
    height: 40px;
    font-size: 1rem;
  }
</style>
</head>
<body>

<!-- ===== Главная страница ===== -->
<div id="homeScreen" class="screen active">
  <button id="addDiscountBtn">Добавить</button>
  <button id="findDiscountBtn">Искать</button>
  <button id="earnEnergyBtn">Энергия</button>
  <div class="energy-bar-container">
    <div id="energyBar" class="energy-bar"></div>
  </div>
  <div id="energySpan" class="energy-text">0</div>
</div>

<!-- ===== Экран добавления ===== -->
<div id="addScreen" class="screen">
  <form class="add-form" id="addForm">
    <input type="text" id="productName" placeholder="Название товара" required>
    <input type="number" id="priceBefore" placeholder="Цена до скидки" required>
    <input type="number" id="priceAfter" placeholder="Цена после скидки" required>
    <input type="text" id="store" placeholder="Магазин" required>
    <input type="text" id="address" placeholder="Адрес" required>
    <select id="category">
      <option value="">Выберите категорию</option>
      <option value="Авто">Авто</option>
      <option value="Еда">Еда</option>
      <option value="Путешествия">Путешествия</option>
      <option value="Одежда">Одежда</option>
      <option value="Другое">Другое</option>
    </select>
    <input type="file" id="photo" accept="image/*">
    <img id="photo-preview">
    <button type="button" id="addBtn">Сохранить</button>
  </form>
  <button class="back-btn" id="backHome1">Назад</button>
</div>

<!-- ===== Firebase ===== -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBJWrVFGL0lt8zMfQH8rrYMOj8CWFVsUCg",
    authDomain: "kwt-discounts.firebaseapp.com",
    projectId: "kwt-discounts",
    storageBucket: "kwt-discounts.firebasestorage.app",
    messagingSenderId: "980335677636",
    appId: "1:980335677636:web:a0566f81b81702af60b991"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Анонимная авторизация
  firebase.auth().signInAnonymously()
    .then(() => console.log("Signed in anonymously"))
    .catch(err => console.error("Auth error:", err.code, err.message));

  // Энергия
  const maxEnergy = 5;
  let energy = Number(localStorage.getItem('energy')) || 0;
  energy = Math.min(energy, maxEnergy);
  const energySpan = document.getElementById('energySpan');
  const energyBar = document.getElementById('energyBar');
  function updateEnergyBar() {
    const percent = (energy / maxEnergy) * 100;
    energyBar.style.width = percent + '%';
    energySpan.innerText = energy;
  }
  updateEnergyBar();

  // Экраны
  const homeScreen = document.getElementById('homeScreen');
  const addScreen = document.getElementById('addScreen');
  const addBtn = document.getElementById('addBtn');
  const photoInput = document.getElementById('photo');
  const preview = document.getElementById('photo-preview');

  document.getElementById('addDiscountBtn').onclick = ()=>{homeScreen.classList.remove('active'); addScreen.classList.add('active');}
  document.getElementById('backHome1').onclick = ()=>{addScreen.classList.remove('active'); homeScreen.classList.add('active');}

  // Фото
  let photoData = null;
  photoInput.addEventListener('change', () => {
    const file = photoInput.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      photoData = e.target.result;
      preview.src = photoData;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  // Добавить товар
  addBtn.addEventListener('click',()=>{
    const name = document.getElementById('productName').value.trim();
    const priceBefore = parseFloat(document.getElementById('priceBefore').value);
    const priceAfter = parseFloat(document.getElementById('priceAfter').value);
    const store = document.getElementById('store').value.trim();
    const address = document.getElementById('address').value.trim();
    const category = document.getElementById('category').value;

    if(!photoData || !name || !store || !address || !category || isNaN(priceBefore) || isNaN(priceAfter)){
      alert('Заполните все поля корректно!');
      return;
    }

    function saveProduct(){
      db.collection('products').add({
        name, priceBefore, priceAfter, store, address, category, photo: photoData, timestamp: Date.now()
      }).then(()=>{
        photoInput.value=''; preview.style.display='none'; photoData=null;
        document.getElementById('productName').value='';
        document.getElementById('priceBefore').value='';
        document.getElementById('priceAfter').value='';
        document.getElementById('store').value='';
        document.getElementById('address').value='';
        document.getElementById('category').value='';
        updateEnergyBar();
        alert('✅ Товар добавлен!');
        addScreen.classList.remove('active');
        homeScreen.classList.add('active');
      }).catch(err=>{
        console.error(err);
        alert('Ошибка при добавлении товара: ' + err.message);
      });
    }

    if(energy>0){
      energy--; localStorage.setItem('energy',energy);
      updateEnergyBar();
      saveProduct();
    } else {
      alert('Нет энергии! Сначала получите энергию.');
    }
  });

  // Заработать энергию
  document.getElementById('earnEnergyBtn').addEventListener('click', ()=>{
    if(energy < maxEnergy){
      energy++;
      localStorage.setItem('energy', energy);
      updateEnergyBar();
      alert('✅ Вы получили 1 энергию!');
    } else {
      alert('Энергия полная!');
    }
  });
</script>

</body>
</html>

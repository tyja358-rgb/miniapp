<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>KWT ‚ö° –°–∫–∏–¥–∫–∏ —Ä—è–¥–æ–º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; background: #f2f7ff; margin:0; padding:15px; }
h2 { text-align:center; margin-bottom:20px; }
.screen { display:none; }
.screen.active { display:block; }
button {
  width: 100%; padding: 15px; margin: 10px 0; border:none; border-radius:8px;
  font-size: 16px; cursor:pointer; color:#fff;
}
button.primary { background:#4CAF50; }
button.secondary { background:#2196F3; }
button.energyBtn { background:#FF9800; }
.card { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.08);}
input, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; font-size:15px; }
img { max-width:100%; border-radius:8px; margin-top:10px; }
.product { border-bottom:1px solid #eee; padding:10px 0; }
.category { font-weight:bold; color:#4CAF50; }
.ad-screen { position:fixed; inset:0; background:#000; color:#fff; display:none; align-items:center; justify-content:center; flex-direction:column; z-index:999; }
</style>
</head>

<body>
<h2>‚ö° –°–∫–∏–¥–∫–∏ —Ä—è–¥–æ–º</h2>

<!-- ===== –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω ===== -->
<div id="homeScreen" class="screen active">
  <button id="addDiscountBtn" class="primary">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É</button>
  <button id="findDiscountBtn" class="secondary">–ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É</button>
  <button id="earnEnergyBtn" class="energyBtn">–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å KWT (—ç–Ω–µ—Ä–≥–∏—é)</button>
  <p>–≠–Ω–µ—Ä–≥–∏—è: <span id="energySpan">0</span></p>
</div>

<!-- ===== –≠–∫—Ä–∞–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏ ===== -->
<div id="addScreen" class="screen">
  <div class="card">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É</h3>
    <input type="file" id="photo" accept="image/*" capture="environment">
    <img id="preview" style="display:none;">
    <input type="text" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
    <input type="number" id="priceBefore" placeholder="–¶–µ–Ω–∞ –¥–æ —Å–∫–∏–¥–∫–∏">
    <input type="number" id="priceAfter" placeholder="–¶–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π">
    <input type="text" id="store" placeholder="–ú–∞–≥–∞–∑–∏–Ω">
    <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞">
    <button id="addBtn" class="primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    <button id="backHomeFromAdd" class="secondary">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<!-- ===== –≠–∫—Ä–∞–Ω –ø–æ–∏—Å–∫–∞/–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–∫–∏–¥–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ ===== -->
<div id="findScreen" class="screen">
  <div class="card">
    <h3>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–∫–∏–¥–∫–∏</h3>

    <select id="filterCategory">
      <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      <option value="–ê–≤—Ç–æ">–ê–≤—Ç–æ</option>
      <option value="–ï–¥–∞">–ï–¥–∞</option>
      <option value="–û–¥–µ–∂–¥–∞">–û–¥–µ–∂–¥–∞</option>
      <option value="–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</option>
      <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
    </select>

    <select id="filterDiscount">
      <option value="0">–í—Å–µ —Å–∫–∏–¥–∫–∏</option>
      <option value="20">‚â• 20%</option>
      <option value="30">‚â• 30%</option>
      <option value="50">‚â• 50%</option>
    </select>

    <input type="text" id="filterStore" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–∞–≥–∞–∑–∏–Ω—É">

    <div id="list"></div>
    <button id="backHome1" class="secondary">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<!-- ===== –≠–ö–†–ê–ù –†–ï–ö–õ–ê–ú–´ ===== -->
<div class="ad-screen" id="adScreen">
  <h2>üì¢ –†–µ–∫–ª–∞–º–∞</h2>
  <p>–†–µ–∫–ª–∞–º–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</p>
  <p id="adTimer">5</p>
</div>

<!-- ===== Firebase ===== -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
  // ===== Firebase config =====
  const firebaseConfig = {
    apiKey: "AIzaSyBJWrVFGL0lt8zMfQH8rrYMOj8CWFVsUCg",
    authDomain: "kwt-discounts.firebaseapp.com",
    projectId: "kwt-discounts",
    storageBucket: "kwt-discounts.appspot.com",
    messagingSenderId: "980335677636",
    appId: "1:980335677636:web:a0566f81b81702af60b991"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== DOM —ç–ª–µ–º–µ–Ω—Ç—ã =====
  const homeScreen = document.getElementById('homeScreen');
  const addScreen = document.getElementById('addScreen');
  const findScreen = document.getElementById('findScreen');
  const addDiscountBtn = document.getElementById('addDiscountBtn');
  const findDiscountBtn = document.getElementById('findDiscountBtn');
  const earnEnergyBtn = document.getElementById('earnEnergyBtn');
  const energySpan = document.getElementById('energySpan');
  const photoInput = document.getElementById('photo');
  const preview = document.getElementById('preview');
  const addBtn = document.getElementById('addBtn');
  const list = document.getElementById('list');
  const adScreen = document.getElementById('adScreen');
  const adTimer = document.getElementById('adTimer');
  const backHome1 = document.getElementById('backHome1');
  const backHomeFromAdd = document.getElementById('backHomeFromAdd');

  const filterCategory = document.getElementById('filterCategory');
  const filterDiscount = document.getElementById('filterDiscount');
  const filterStore = document.getElementById('filterStore');

  let photoData = null;
  let energy = Number(localStorage.getItem('energy')) || 0;
  energySpan.innerText = energy;

  // ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è =====
  function showScreen(screen) {
    homeScreen.classList.remove('active');
    addScreen.classList.remove('active');
    findScreen.classList.remove('active');
    screen.classList.add('active');
  }

  addDiscountBtn.addEventListener('click', () => showScreen(addScreen));
  findDiscountBtn.addEventListener('click', () => showScreen(findScreen));
  backHome1.addEventListener('click', () => showScreen(homeScreen));
  backHomeFromAdd.addEventListener('click', () => showScreen(homeScreen));

  // ===== –≠–Ω–µ—Ä–≥–∏—è =====
  earnEnergyBtn.addEventListener('click', () => {
    showAd(() => {
      energy++;
      localStorage.setItem('energy', energy);
      energySpan.innerText = energy;
      alert('‚úÖ –í—ã –ø–æ–ª—É—á–∏–ª–∏ 1 —ç–Ω–µ—Ä–≥–∏—é!');
    });
  });

  // ===== –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ç–æ =====
  photoInput.addEventListener('change', () => {
    const file = photoInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      photoData = e.target.result;
      preview.src = photoData;
      preview.style.display = 'block';
      if (energy > 0) {
        energy--;
        localStorage.setItem('energy', energy);
        energySpan.innerText = energy;
      }
    };
    reader.readAsDataURL(file);
  });

  // ===== –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ =====
  function detectCategory(name) {
    const t = name.toLowerCase();
    if (t.includes('–∞–≤—Ç–æ')) return '–ê–≤—Ç–æ';
    if (t.includes('–µ–¥–∞') || t.includes('–∫–∞—Ñ–µ') || t.includes('—Ä–µ—Å—Ç–æ—Ä–∞–Ω')) return '–ï–¥–∞';
    if (t.includes('–±–∏–ª–µ—Ç')) return '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è';
    if (t.includes('–æ–¥–µ–∂')) return '–û–¥–µ–∂–¥–∞';
    return '–î—Ä—É–≥–æ–µ';
  }

  // ===== –†–µ–∫–ª–∞–º–∞ =====
  function showAd(callback) {
    let time = 5;
    adTimer.innerText = time;
    adScreen.style.display = 'flex';
    const interval = setInterval(() => {
      time--;
      adTimer.innerText = time;
      if (time <= 0) {
        clearInterval(interval);
        adScreen.style.display = 'none';
        callback();
      }
    }, 1000);
  }

  // ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ =====
  addBtn.addEventListener('click', () => {
    const name = document.getElementById('productName').value.trim();
    const priceBefore = parseFloat(document.getElementById('priceBefore').value);
    const priceAfter = parseFloat(document.getElementById('priceAfter').value);
    const store = document.getElementById('store').value.trim();
    const address = document.getElementById('address').value.trim();

    if (!photoData || !name || !store || !address || isNaN(priceBefore) || isNaN(priceAfter)) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
      return;
    }

    const discount = ((priceBefore - priceAfter)/priceBefore*100).toFixed(0);
    if (discount < 20) { alert('–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ –º–µ–Ω—å—à–µ 20%'); return; }

    function saveProduct() {
      const category = detectCategory(name);
      db.collection('products').add({
        name, priceBefore, priceAfter, discount, store, address, category,
        photo: photoData, timestamp: Date.now()
      }).then(() => {
        alert('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω! –í–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±–µ—Å—Ü–µ–Ω–Ω–∞.');
        photoInput.value = '';
        preview.style.display = 'none';
        document.getElementById('productName').value = '';
        document.getElementById('priceBefore').value = '';
        document.getElementById('priceAfter').value = '';
        document.getElementById('store').value = '';
        document.getElementById('address').value = '';
        photoData = null;
        showScreen(homeScreen);
      });
    }

    if (energy > 0) {
      energy--;
      localStorage.setItem('energy', energy);
      energySpan.innerText = energy;
      saveProduct();
    } else {
      showAd(saveProduct);
    }
  });

  // ===== –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ =====
  function renderProducts(snapshot) {
    const categoryFilter = filterCategory.value;
    const discountFilter = Number(filterDiscount.value);
    const storeFilter = filterStore.value.toLowerCase();

    list.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      if (categoryFilter && data.category !== categoryFilter) return;
      if (data.discount < discountFilter) return;
      if (storeFilter && !data.store.toLowerCase().includes(storeFilter)) return;

      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <div class="category">${data.category}</div>
        <strong>${data.name}</strong><br>
        ${data.store}, ${data.address}<br>
        –¶–µ–Ω–∞: ${data.priceBefore} ‚Üí ${data.priceAfter} (${data.discount}%)<br>
        <img src="${data.photo}">
      `;
      list.appendChild(div);
    });
  }

  db.collection('products').orderBy('timestamp','desc')
    .onSnapshot(snapshot => renderProducts(snapshot));

  // ===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ =====
  filterCategory.addEventListener('change', () => db.collection('products').orderBy('timestamp','desc').get().then(renderProducts));
  filterDiscount.addEventListener('change', () => db.collection('products').orderBy('timestamp','desc').get().then(renderProducts));
  filterStore.addEventListener('input', () => db.collection('products').orderBy('timestamp','desc').get().then(renderProducts));

</script>
</body>
</html>

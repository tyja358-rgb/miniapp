<script>
  // ===== Доп. данные для Магазинов =====
  let stores = JSON.parse(localStorage.getItem('stores')) || [];

  function saveStores() {
    localStorage.setItem('stores', JSON.stringify(stores));
  }

  // ===== Открытие категории Магазины =====
  function openStoresCategory() {
    let storeName = prompt("Выберите магазин или добавьте новый (оставьте пустым, чтобы выбрать существующий)");
    
    if (!storeName) {
      if (stores.length === 0) {
        alert("Нет магазинов. Добавьте новый через кнопку 'Добавить новый магазин'");
        return;
      }
      // Выбор существующего магазина
      let names = stores.map(s => s.name).join("\n");
      storeName = prompt("Выберите магазин:\n" + names);
      if (!storeName || !stores.find(s => s.name === storeName)) return;
    }

    let store = stores.find(s => s.name === storeName);
    if (!store) {
      // Новый магазин
      store = { name: storeName, addresses: [] };
      stores.push(store);
      saveStores();
      alert(`Магазин "${storeName}" добавлен`);
    }

    openStoreAddresses(store);
  }

  // ===== Адреса магазина =====
  function openStoreAddresses(store) {
    let address = prompt("Выберите адрес магазина или добавьте новый (оставьте пустым для выбора существующего)");

    if (!address) {
      if (store.addresses.length === 0) {
        alert("Нет адресов. Добавьте новый через кнопку 'Добавить новый адрес'");
        return;
      }
      // Выбор существующего адреса
      let addrList = store.addresses.map(a => a.address).join("\n");
      address = prompt("Выберите адрес:\n" + addrList);
      if (!address || !store.addresses.find(a => a.address === address)) return;
    }

    let addrObj = store.addresses.find(a => a.address === address);
    if (!addrObj) {
      // Новый адрес
      addrObj = { address: address, products: [] };
      store.addresses.push(addrObj);
      saveStores();
      alert(`Адрес "${address}" добавлен`);
    }

    addProduct(store, addrObj);
  }

  // ===== Добавление товара =====
  function addProduct(store, addrObj) {
    // Реклама перед добавлением
    showAd(() => {
      const name = prompt("Название товара:");
      const priceBefore = parseFloat(prompt("Цена до скидки:"));
      const priceAfter = parseFloat(prompt("Цена после скидки:"));
      const photo = prompt("Вставьте ссылку на фото или оставьте пустым для теста:");

      if (!name || isNaN(priceBefore) || isNaN(priceAfter)) {
        alert("Некорректные данные. Товар не добавлен.");
        return;
      }

      if ((priceBefore - priceAfter) / priceBefore * 100 < 20) {
        alert("Скидка должна быть не меньше 20%");
        return;
      }

      addrObj.products.push({ name, priceBefore, priceAfter, photo });
      saveStores();
      alert(`Товар "${name}" добавлен в ${store.name}, ${addrObj.address}`);
    });
  }

  // ===== Реклама =====
  function showAd(callback) {
    let adTime = 5;
    alert(`Реклама! Подождите ${adTime} секунд (симулируем)`);
    setTimeout(callback, adTime * 1000);
  }

  // ===== Подключение к стартовым кнопкам =====
  document.getElementById('addDiscountBtn').onclick = () => {
    const category = prompt("Введите категорию: Для теста напишите 'Магазины'");
    if (category && category.toLowerCase() === 'магазины') openStoresCategory();
    else alert("Категория пока не реализована");
  };

  document.getElementById('findDiscountBtn').onclick = () => {
    const category = prompt("Введите категорию: Для теста напишите 'Магазины'");
    if (category && category.toLowerCase() === 'магазины') openStoresCategory();
    else alert("Категория пока не реализована");
  };
</script>

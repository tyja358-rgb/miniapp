<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniApp Start</title>
<style>
  body {
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #6a0dad, #4b0082);
    font-family: Arial, sans-serif;
  }

  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
  }

  button {
    width: 220px;
    height: 70px;
    border-radius: 35px;
    border: none;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    background: linear-gradient(145deg, #1c1c1c, #333);
  }

  button:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 20px rgba(0,0,0,0.4);
  }

  .energy-bar {
    width: 250px;
    height: 25px;
    background: #555;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 15px;
  }

  .energy-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffcc00, #ffd700);
    width: 0%;
    transition: width 0.3s;
  }

  #energy-text {
    margin-top: 5px;
    color: white;
    font-weight: bold;
    font-size: 18px;
    text-align: center;
  }

</style>
</head>
<body>

<div class="container">
  <button id="addDiscountBtn">Добавить</button>
  <button id="findDiscountBtn">Найти</button>
  <button id="earnEnergyBtn">Энергия</button>

  <div class="energy-bar">
    <div class="energy-fill" id="energyBar"></div>
  </div>
  <div id="energy-text">0 / 5</div>
</div>

<script>
  // ===== Энергия =====
  const maxEnergy = 5;
  let energy = Number(localStorage.getItem('energy')) || 0;
  energy = Math.min(energy, maxEnergy);
  const energyBar = document.getElementById('energyBar');
  const energyText = document.getElementById('energy-text');

  function updateEnergyBar() {
    const percent = (energy / maxEnergy) * 100;
    energyBar.style.width = percent + '%';
    energyText.innerText = `${energy} / ${maxEnergy}`;
  }

  updateEnergyBar();

  document.getElementById('earnEnergyBtn').onclick = () => {
    if (energy < maxEnergy) energy++;
    localStorage.setItem('energy', energy);
    updateEnergyBar();
    alert('✅ Вы получили 1 энергию!');
  };

  // ===== Магазины и товары =====
  const shops = []; // пока пустой массив, пользователь добавляет сам

  function addShop(name) {
    if (!shops.some(s => s.name === name)) {
      shops.push({ name, addresses: [] });
      shops.sort((a,b)=>a.name.localeCompare(b.name));
    }
  }

  function addAddress(shopName, address) {
    const shop = shops.find(s => s.name===shopName);
    if(shop && !shop.addresses.some(a=>a.name===address)) {
      shop.addresses.push({ name: address, items: [] });
    }
  }

  function addItem(shopName, addressName, itemName, priceBefore, priceAfter) {
    const shop = shops.find(s=>s.name===shopName);
    if(!shop) return;
    const addr = shop.addresses.find(a=>a.name===addressName);
    if(!addr) return;
    addr.items.push({ name: itemName, priceBefore, priceAfter });
  }

  // ===== Кнопки =====
  document.getElementById('addDiscountBtn').onclick = () => {
    // Добавление магазина/адреса/товара
    const shopName = prompt("Введите название магазина:");
    if(!shopName) return;
    addShop(shopName);

    const addressName = prompt("Введите адрес магазина:");
    if(!addressName) return;
    addAddress(shopName, addressName);

    const itemName = prompt("Введите название товара:");
    if(!itemName) return;

    let priceBefore = parseFloat(prompt("Цена до скидки:"));
    if(isNaN(priceBefore)) return;
    let priceAfter = parseFloat(prompt("Цена после скидки:"));
    if(isNaN(priceAfter)) return;

    if(priceBefore - priceAfter < 0.2*priceBefore) {
      alert("❌ Скидка меньше 20%");
      return;
    }

    addItem(shopName, addressName, itemName, priceBefore, priceAfter);
    alert("✅ Товар добавлен!");
  };

  document.getElementById('findDiscountBtn').onclick = () => {
    if(shops.length===0){
      alert("Нет добавленных магазинов.");
      return;
    }

    // Шаг 1: выбрать магазин
    const shopNames = shops.map((s,i)=>`${i+1}. ${s.name}`).join('\n');
    const shopIndex = parseInt(prompt("Выберите магазин:\n"+shopNames))-1;
    if(isNaN(shopIndex) || !shops[shopIndex]) return;
    const shop = shops[shopIndex];

    // Шаг 2: выбрать товар
    let allItems = [];
    shop.addresses.forEach(a=>allItems.push(...a.items));
    if(allItems.length===0){ alert("Нет товаров в этом магазине."); return; }

    allItems = [...new Map(allItems.map(i=>[i.name,i])).values()]; // уникальные по имени
    const itemNames = allItems.map((i,j)=>`${j+1}. ${i.name} (${i.priceBefore} → ${i.priceAfter})`).join('\n');
    const itemIndex = parseInt(prompt("Выберите товар:\n"+itemNames))-1;
    if(isNaN(itemIndex) || !allItems[itemIndex]) return;
    const selectedItem = allItems[itemIndex];

    // Шаг 3: выбрать адрес
    const validAddresses = shop.addresses.filter(a=>a.items.some(it=>it.name===selectedItem.name));
    const addressNames = validAddresses.map((a,j)=>`${j+1}. ${a.name}`).join('\n');
    const addressIndex = parseInt(prompt("Выберите адрес для товара:\n"+addressNames))-1;
    if(isNaN(addressIndex) || !validAddresses[addressIndex]) return;

    alert(`Вы выбрали:\nМагазин: ${shop.name}\nТовар: ${selectedItem.name}\nАдрес: ${validAddresses[addressIndex].name}`);
  };

</script>

</body>
</html>
